// Generated by CoffeeScript 1.8.0
(function() {
  window.Visualizer = (function() {
    Visualizer.prototype.keys = {
      PAUSE: 32,
      NEXT: 78
    };

    function Visualizer(viewer) {
      this.viewer = viewer;
      this.player = new Player();
      this.player.createLiveInput();
      this.choreographyRoutine = new ChoreographyRoutine(this);
      this.setupPopup();
      this.setupGUI();
      this.choreographyRoutine.playNext();
    }

    Visualizer.prototype.setupPopup = function() {
      return $('#viewerButton').click((function(_this) {
        return function(e) {
          var popupURL, sendBeats;
          e.preventDefault();
          _this.domain = window.location.protocol + '//' + window.location.host;
          popupURL = _this.domain + location.pathname + 'viewer.html';
          _this.popup = window.open(popupURL, 'myWindow');
          sendBeats = function() {
            var routineBeat, _results;
            routineBeat = _this.choreographyRoutine.routineBeat;
            _this.choreographyRoutine.routineBeat = -1;
            _results = [];
            while (_this.choreographyRoutine.routineBeat < routineBeat) {
              _results.push(_this.choreographyRoutine.playNext());
            }
            return _results;
          };
          return setTimeout(sendBeats, 100);
        };
      })(this));
    };

    Visualizer.prototype.setupGUI = function() {
      var danceController, danceFolder, danceMaterialController, danceMaterialFolder, dancerController, dancerFolder, gui, idController, setupFolder, updateFolder, _ref, _ref1, _ref2;
      gui = new dat.GUI();
      gui.add(this.player.audioWindow, 'responsiveness', 0.0, 5.0);
      idController = gui.add(this.choreographyRoutine, 'id');
      setupFolder = (function(_this) {
        return function(name, varName, keys) {
          var controller, folder;
          controller = gui.add(_this.choreographyRoutine, varName, keys);
          folder = gui.addFolder(name);
          folder.open();
          return [controller, folder];
        };
      })(this);
      updateFolder = function(types, folder, params, value, obj) {
        var param, _i, _len, _ref, _ref1, _results;
        if (types[value] == null) {
          return;
        }
        while (folder.__controllers[0] != null) {
          folder.remove(folder.__controllers[0]);
        }
        _ref = types[value].params;
        _results = [];
        for (_i = 0, _len = _ref.length; _i < _len; _i++) {
          param = _ref[_i];
          params[param.name] = (obj != null ? (_ref1 = obj.options) != null ? _ref1[param.name] : void 0 : void 0) ? obj.options[param.name] : param["default"];
          _results.push(folder.add(params, param.name));
        }
        return _results;
      };
      _ref = setupFolder('Dancer parameters', 'dancer', Object.keys(Visualizer.dancerTypes)), dancerController = _ref[0], dancerFolder = _ref[1];
      dancerController.onChange((function(_this) {
        return function(value, obj) {
          return updateFolder(Visualizer.dancerTypes, dancerFolder, _this.choreographyRoutine.dancerParams, value, obj);
        };
      })(this));
      _ref1 = setupFolder('Dance parameters', 'dance', Object.keys(Visualizer.danceTypes)), danceController = _ref1[0], danceFolder = _ref1[1];
      danceController.onChange((function(_this) {
        return function(value, obj) {
          return updateFolder(Visualizer.danceTypes, danceFolder, _this.choreographyRoutine.danceParams, value, obj);
        };
      })(this));
      _ref2 = setupFolder('Dance material paramaters', 'danceMaterial', Object.keys(Visualizer.danceMaterialTypes)), danceMaterialController = _ref2[0], danceMaterialFolder = _ref2[1];
      danceMaterialController.onChange((function(_this) {
        return function(value, obj) {
          return updateFolder(Visualizer.danceMaterialTypes, danceMaterialFolder, _this.choreographyRoutine.danceMaterialParams, value, obj);
        };
      })(this));
      idController.onChange((function(_this) {
        return function(value) {
          var controller, idDancer, _i, _len, _ref3;
          idDancer = _this.viewer.getDancer(value);
          if (idDancer != null) {
            _this.choreographyRoutine.updateDancer(idDancer);
            _ref3 = gui.__controllers;
            for (_i = 0, _len = _ref3.length; _i < _len; _i++) {
              controller = _ref3[_i];
              controller.updateDisplay();
            }
            updateDancerFolder(_this.choreographyRoutine.dancer, idDancer);
            updateDanceMaterialFolder(_this.choreographyRoutine.danceMaterial, idDancer.danceMaterial);
            return updateDanceFolder(_this.choreographyRoutine.dance, idDancer.dance);
          }
        };
      })(this));
      gui.add(this.choreographyRoutine, 'preview');
      gui.add(this.choreographyRoutine, 'add');
      gui.add(this.choreographyRoutine, 'insertBeat');
      gui.add(this.choreographyRoutine, 'playNext');
      return gui.add(this.choreographyRoutine, 'reset');
    };

    Visualizer.prototype.receiveChoreography = function(move) {
      this.viewer.receiveChoreography(move);
      if (this.popup != null) {
        return this.popup.postMessage(this.wrapMessage('choreography', move), this.domain);
      }
    };

    Visualizer.prototype.render = function() {
      if (!this.player.playing) {
        return;
      }
      this.player.update();
      this.viewer.render(this.player.audioWindow);
      if (this.popup != null) {
        return this.popup.postMessage(this.wrapMessage('render', this.player.audioWindow), this.domain);
      }
    };

    Visualizer.prototype.wrapMessage = function(type, data) {
      return {
        type: type,
        data: data
      };
    };

    Visualizer.prototype.onKeyDown = function(event) {
      switch (event.keyCode) {
        case this.keys.PAUSE:
          return this.player.pause();
        case this.keys.NEXT:
          return this.choreographyRoutine.playNext();
      }
    };

    Visualizer.dancerTypes = {
      CubeDancer: CubeDancer,
      SphereDancer: SphereDancer,
      PointCloudDancer: PointCloudDancer
    };

    Visualizer.danceTypes = {
      ScaleDance: ScaleDance,
      PositionDance: PositionDance,
      RotateDance: RotateDance
    };

    Visualizer.danceMaterialTypes = {
      ColorDanceMaterial: ColorDanceMaterial,
      SimpleFrequencyShader: SimpleFrequencyShader
    };

    return Visualizer;

  })();

}).call(this);

//# sourceMappingURL=Visualizer.js.map
